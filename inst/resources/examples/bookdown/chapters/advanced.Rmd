# (PART) 応用編 {-}

# このパートについて {-}

このパートでは, ここまでで紹介した基本機能の応用で,  さまざまな R パッケージやその他の外部プログラムの出力を埋め込む方法を紹介する

# 様々なグラフィックプログラムの埋め込み {#advanced-graph}

## `tikz` を使う

`r rmdja::texlogo("latex")` で使われる `tikzdevice` を利用して, 直接  `tikz` の記述による画像を埋め込むことができる. チャンクのエンジンを `tikz` とすることで使用でき, 相互参照やキャプション, 画像サイズの指定といったチャンクオプションも使える. 図 \@ref(fig:tikz-venn) は `tikz` で生成した図である. これはHTMLでも表示できる. TODO: しかし現状ではpdflatex以外のエンジンに変更できないため, 日本語表示が難しい.

```{tikz tikz-venn, fig.cap="tikzを利用した図の表示"}
\def\firstcenter{(135:1.75cm)}
\def\secondcenter{(45:1.75cm)}
\def\firstcircle{\firstcenter circle (2.0cm)}
\def\secondcircle{\secondcenter circle (2.0cm)}
\def\wholerect{(-4.0, -1.1) rectangle(4.0, 3.35)}
\begin{tabular}{cc}
  % A cap B
  \begin{tikzpicture}
    \begin{scope}
       \clip \secondcircle;
       \fill[cyan] \firstcircle;
    \end{scope}
    \draw \wholerect;
    \draw \firstcircle;
    \draw \secondcircle;
    \begin{scope}[font=\small]
      \draw(90:.5cm) node[text=black, below]{\texttt{A INNER JOIN B}};
    \end{scope}
  \end{tikzpicture}
&
  % A u B
  \begin{tikzpicture}
    \begin{scope}
       \draw \wholerect;
       \fill[cyan]\firstcircle;
       \fill[cyan]\secondcircle;
     \end{scope}
     \begin{scope}[font=\small]
       \draw(90:.5cm) node[text=white, below]{\texttt{A OUTER JOIN B}};
     \end{scope}
  \end{tikzpicture}
\\
  % A LEFT B
  \begin{tikzpicture}
    \draw \wholerect;
    \draw \firstcircle;
    \draw \secondcircle;
    \begin{scope}
      \fill[cyan]\firstcircle;
      \draw\firstcenter;
      \draw\secondcenter;
   \end{scope}
   \begin{scope}[font=\small]
      \draw\firstcenter node[text=black, below]{\texttt{A LEFT JOIN B}};
   \end{scope}
  \end{tikzpicture}
&
  % A RIGHT B
  \begin{tikzpicture}
    \draw \wholerect;
    \draw \firstcircle;
    \draw \secondcircle;
    \begin{scope}
      \fill[cyan]\secondcircle;
      \draw\firstcenter;
      \draw\secondcenter;
   \end{scope}
   \begin{scope}[font=\small]
      \draw\secondcenter node[text=black, below]{\texttt{A RIGHT JOIN B}};
   \end{scope}
  \end{tikzpicture}
\\
\end{tabular}
```

## Asymptote を使う

同様に, Asymptote のプログラムを埋め込むこともできる. 私は Asymptote が分からないので RCB [Ch. 15.9 Create graphics with Asymptote](https://bookdown.org/yihui/rmarkdown-cookbook/eng-asy.html) と同様のプログラムを書いておく. (図 \@ref(fig:asymptote-graph)).

```{asy asymptote-graph, out.height="50%", fig.cap="Asymptote による画像"}
import graph3;
import grid3;
import palette;
settings.prc = false;
currentprojection=orthographic(0.8,1,2);
size(500,400,IgnoreAspect);
real f(pair z) {return cos(2*pi*z.x)*sin(2*pi*z.y);}
surface s=surface(f,(-1/2,-1/2),(1/2,1/2),50,Spline);
surface S=planeproject(unitsquare3)*s;
S.colors(palette(s.map(zpart),Rainbow()));
draw(S,nolight);
draw(s,lightgray+opacity(0.7));
grid3(XYZgrid);
```

## (TODO) その他のプログラム

D3.js なども使える

## (TODO) その他の R プログラム

なお, DOT言語は `DiagrammeR` パッケージを経由して使うこともできる[^rcb-diagrammer](図: \@ref(fig:diagrammer-graph)). グラフィカルモデルの記述などはこちらのほうが簡単かもしれない.

(ref:diagrammer-cap) `DiagrammeR` によるグラフィカルモデル (RCB, Ch. 4.15 より)

```{r diagrammer-graph, echo=T, fig.cap="(ref:diagrammer-cap)"}
DiagrammeR::grViz("digraph {
  graph [layout = dot, rankdir = TB]
  
  node [shape = rectangle]        
  rec1 [label = 'Step 1. 起床する']
  rec2 [label = 'Step 2. コードを書く']
  rec3 [label =  'Step 3. ???']
  rec4 [label = 'Step 4. 給料をもらう']
  
  # edge definitions with the node IDs
  rec1 -> rec2 -> rec3 -> rec4
  }", 
  height = 500)
```

[^rcb-diagrammer]: https://bookdown.org/yihui/rmarkdown-cookbook/diagrams.html


# 表のデザイン {#advanced-tabulate}

## TeX/HTML を出力する関数

`stargazer` や `xtable` のように, HTML や `\LaTeX`{=latex}`LaTeX`{=html} 形式で表を出力してくれるパッケージがある. これらは `results='asis'` のチャンクオプションを指定することで関数の出力するテキストをそのまま埋め込むことができる. よって, あとは HTMLか`\LaTeX`{=latex}`LaTeX`{=html} かといった出力形式の違いに気をつければ表示できる (図 \@ref(tab:stargazer-table)).

(ref:stargazer-title) `stargazer` による表の出力

```{r stargazer-table, echo=T, message=F, results='asis'}
require(stargazer)
stargazer(mtcars, type = if(knitr::is_latex_output()) 'latex' else 'html',
          header = F, title = "(ref:stargazer-title)")
```

その他, `Hmisc::latex()`, `stats::xtable()` という古典的な関数がある. 後者は名前の通り `r rmdja::texlogo("LaTeX")` のソースをかなりの自由度で出力できるが, ここまでやるならもう最初から `r rmdja::texlogo("LaTeX")` で書いたほうがいいのでは, というレベルである. `r rmdja::texlogo("LaTeX")` に詳しくない場合, かえって難しいかも知れない. `stargazer` や後述する `kableExtra` でできる範囲でやったほうが簡単だし, 過剰な装飾の表ができあがることも少ない.

## `kableExtra` による表のスタイルのカスタマイズ

```{r kableextra-logo, out.width="10%"}
include_graphics(if(is_latex_output()) "img/kableExtra.pdf" else "img/kableExtra.svg")
```

`kableExtra` パッケージは `knitr::kable` の拡張であり, 様々なスタイルの表を出力できる. そしてそれは HTML でも PDF でも有効である.

まず, (これは `kable()` からある機能だが) `booktabs = T` を指定する. `r rmdja::texlogo("LaTeX")` のデフォルトの表は罫線が多すぎる. 罫線は牢獄の格子を暗示するため過剰な罫線にまみれた表を書いたり眺めたりしていると精神が抑圧され有害であると心理学的にも証明されている (**嘘**). しかし `booktabs = T` はこれだけで `booktabs.sty` に準拠した見やすいスタイルに変更してくれる. さらに `kableExtra` の機能として, 表 \@ref(tab:kableextra-color) にみられるように条件書式のような装飾が可能である.

(ref:kableextra-color-cap) `kabeExtra` パッケージを利用した表の作成, 公式ドキュメントの用例より

```{r kableextra-color, echo=T, message=F}
that_cell <- c(rep(F, 7), T)
mtcars[1:8, 1:8] %>%
  kbl(booktabs = T, linesep = "", format = if(knitr::is_latex_output()) "latex" else "html",
      caption = "(ref:kableextra-color-cap)") %>%
  kable_paper(full_width = F) %>%
  column_spec(2, color = spec_color(mtcars$mpg[1:8]),
              link = "https://haozhu233.github.io/kableExtra") %>%
  column_spec(6, color = "white",
              background = spec_color(mtcars$drat[1:8], end = 0.7),
              popover = paste("am:", mtcars$am[1:8])) %>%
  column_spec(9, strikeout = that_cell, bold = that_cell,
              color = c(rep("black", 7), "red"))
```

グラフのインライン挿入も可能である (表 \@ref(tab:kableextra-plot)).

(ref:kableextra-plot-cap)  `kabeExtra` パッケージによる表内グラフ, 公式ドキュメントの用例より

```{r kableextra-plot, echo=T}
mpg_list <- split(mtcars$mpg, mtcars$cyl)
disp_list <- split(mtcars$disp, mtcars$cyl)
inline_plot <- data.frame(cyl = c(4, 6, 8), mpg_box = "", mpg_hist = "",
mpg_line1 = "", mpg_line2 = "", mpg_points1 = "", mpg_points2 = "", mpg_poly = "")
inline_plot %>%
  kbl(booktabs = T, format = if(knitr::is_latex_output()) "latex" else "html",
      caption = "(ref:kableextra-plot-cap)"
      ) %>%
kable_paper(full_width = FALSE) %>%
  column_spec(2, image = spec_boxplot(mpg_list)) %>%
  column_spec(3, image = spec_hist(mpg_list)) %>%
  column_spec(4, image = spec_plot(mpg_list, same_lim = TRUE)) %>%
  column_spec(5, image = spec_plot(mpg_list, same_lim = FALSE)) %>%
  column_spec(6, image = spec_plot(mpg_list, type = "p")) %>%
  column_spec(7, image = spec_plot(mpg_list, disp_list, type = "p")) %>%
  column_spec(8, image = spec_plot(mpg_list, polymin = 5))
```

その他細かい使用上の注意をいくつか挙げる.

* `kableExtra::` で参照するのではなく, 最初にパッケージをロードしたほうが不具合が起きにくい.
* PDF に出力する場合, 多くの `r rmdja::texlogo("LaTeX")` パッケージのロードが必要だが, `rmdja` のPDFフォーマットはいずれもテンプレートに組み込んでいるため手動設定は必要ない.
* `knitr::kable()` または `kableExtra::kbl()` の `format` でHTML/texの出力を決める. 現在は判定が自動化されたとのことだが, まれに不具合があるという報告もみられる. よって, どちらも出力したい場合は上記のように `format = knitr::is_latex_output()` で条件分岐させるのが1つの手である.
* 表のキャプションは図のようにチャンクオプションに指定するのではなく, `kbl()`/`kable()` の `caption` 引数に指定する
* キャプション内にMarkdown記法や相互参照など特殊な構文を含めたい場合は, `escape = F` を指定する.

その他, テキストの回り込み, 画像の挿入など様々なことが可能である. 詳細は公式の解説である "[Create Awesome HTML Table with knitr::kable and kableExtra](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)" および [PDF版](http://haozhu233.github.io/kableExtra/awesome_table_in_pdf.pdf) が役に立つ.

## `formattable` パッケージとの併用

`formattable` パッケージは以前からある表を装飾するパッケージである. `kableExtra` との併用も可能だが, **`r rmdja::texlogo("LaTeX")`  に対応しておらず**, HTMLタグをtexファイルに吐き出してしまうため動作しない. PDF にも同様に表示するには [StackOverflow](https://stackoverflow.com/questions/34983822/how-to-have-r-formattable-rendered-to-pdf-output-and-how-to-have-percents-in-the)で提案されているように, `webshot` 使うなど工夫が必要である. そこまでしてこの装飾にこだわるメリットは薄いと私は考えるので現在この問題に対応する予定はない. かわりに後述する `huxtable` または `gt` を使うべきだと考える. 

## `huxtable` パッケージによる作表

```{r huxtable-logo}
huxtable::hux_logo(latex = is_latex_output(), html = is_html_output())
```

[`huxtable`](https://hughjonesd.github.io/huxtable/) は HTML と `r rmdja::texlogo("LaTeX")` に対応した作表パッケージであり, 公式ドキュメントによると他の類似パッケージと比較して多機能であることを強調している. 全体的に `tidyverse` を意識した構文が用意され, `kableExtra` のようにパイプラインを使った記述が捗る. なお `huxtable` のロゴはランダムに生成される. さらに「1行ごとに背景色を変更」「`stargazer`風の表」などよく使われるスタイルを簡単に設定できるようになっていたり, はては `tidyr` のような表のロング・ワイド変形機能まで備えている.

(ref:huxtable-example-cap) `huxtable` パッケージによる作表

```{r huxtable-example, echo=T, message=F}
require(huxtable)
head(mtcars[1:5]) %>%
  as_huxtable(add_rownames = "Model") %>%
  set_caption("(ref:huxtable-example-cap)") %>%
  set_bold(1, everywhere, T) %>%
  theme_article() %>%
  map_text_color(
    everywhere, "mpg", by_colorspace("navy", "red", "yellow")) %>%
  map_background_color(
    everywhere, "hp", by_quantiles(0.8, c("white", "yellow"))) %>%
  map_italic(everywhere, "Model", by_regex("Merc.*" = T)) %>%
  set_number_format(col = "drat", value = fmt_percent(digits = 2))
```

そのままでは罫線の設定が `set_top_border()`, `set_bottom_border()`, などしかなく, 複雑な条件を指定するのが大変だが, `ggplot2` のテーマ関数のようにスタイルのプリセットが `theme_*()` の名前でいくつか用意されている. 例えば上記では `theme_article()` という学術論文風テーマを適用し, 表の上下とヘッダにだけ罫線を引いている. 条件書式は `map_*()` 関数群で実行できる. また, フォーマットは `set_number_format()` に値を変換するフォーマット関数を与える形で適用できる. こちらはパーセンテージなども正しく表示できる.

また, `huxreg()` は名前の通り回帰分析の結果を表にするなど `stargazer` パッケージに似た機能を提供する. これも同じクラスなので同様にスタイル設定が可能である (表 \@ref(tab:huxreg-example)).

(ref:huxreg-example-cap) `huxtable::huxreg()` による出力

```{r huxreg-example, echo=T}
lm1 <- lm(mpg ~ cyl, mtcars)
lm2 <- lm(mpg ~ cyl + hp, mtcars)
glm1 <- glm(I(mpg > 20) ~ cyl, mtcars,
          family = binomial)
huxreg(lm1, lm2, glm1) %>%
  set_caption("(ref:huxreg-example-cap)") %>%
  set_text_color(everywhere, "model1", "green") %>%
  set_text_color(everywhere, "model2", "blue")
```

その他の作例は [CRANの 公式 vignettes](https://cran.r-project.org/web/packages/huxtable/vignettes/huxtable.html) を参考にせよ.


## (TODO) `gt` パッケージによる作表

```{r gt-logo, out.width="10%"}
include_graphics(if(is_latex_output()) "img/gt.pdf" else "img/gt.svg")
```

[`gt`](https://github.com/rstudio/gt) パッケージは RStudio 社によって開発されている. `kableExtra` や `huxtable` が行や列を単位にスタイルを設定する設計だったのに対し, `gt` はデータフレームに ヘッダ, 列ラベル, スタブ, 脚注, といったパーツに分けて設定して表を作成する.

`gt` はあまり複雑な条件書式の機能はない. そのかわりヘッダや行ラベルの表現に自由度がある. たとえば "[Case Study: gtcars](https://gt.rstudio.com/articles/case-study-gtcars.html)" には

```{r gt-example, echo=T, message=F}
require(gt)
gtcars %>%
  dplyr::group_by(ctry_origin) %>%
  dplyr::top_n(2) %>%
  dplyr::ungroup() %>%
  dplyr::filter(ctry_origin != "United Kingdom") %>%
  dplyr::group_by(ctry_origin) %>%
  gt() %>% as_latex()
```

よって, `gt` パッケージはこのようにカテゴリや列をグループ化して掲載する表を比較的簡単に作りやすいことがわかる (個人的には単純なマトリクスで表現できないものを表にするのは気が進まないが...).

一方で `gt` の問題点として, 相互参照が面倒だというものがある. TODO

## その他の作表パッケージ

`df_print` チャンクオプションで, デフォルトの表示方法を変更することもできる. ここまで `kable` での出力を前提としていたが, 長大な表を掲載したい場合, `paged` オプションがある.

それ以外に有名なパッケージとして, `DT`, `flextable` がある. 前者はインタラクティブな表ウィジェットを作成し, 後者はむしろ Word へのエクスポート機能をフィーチャーしており `rmdja` の方向性とは異なる. 加えて既に紹介した `huxtable` または `gt` でだいたいのことはできるため, これ以上の紹介は避ける.

RCB [10.3 Other packages for creating tables](https://bookdown.org/yihui/rmarkdown-cookbook/table-other.html) も参考にせよ.

# 文献引用 

## `(u)p\BibTeX`{=latex}`(u)pBibTeX`{=html} を使う

日本語対応 `.bst` ファイルを使いたい場合は少しトリッキーな操作が必要になる. `rmarkdown` は `tinytex` というパッケージでインストールされたスタンドアローンな処理系で PDF を生成している. 冒頭のチャンクで `options(tinytex.latexmk.emulation = F)` を指定することで, 自分のマシンにインストールされている普段使っている処理系に処理させることができる. さらに `rmdja` では `natbib` を指定した場合に自動でカレントディレクトリに `.latexmkrc` をコピーするようにしている. しかしログが残らないなどデバッグしづらいところがあるため, このやり方はやや使いづらい.

# (TODO) Web アプレットの挿入 {#webapp}

### TODO: plotly

### TODO: shiny

# Python スクリプトの埋め込み {#python}

Python スクリプトを埋め込むこともできる. 方法は2通りあり, 都度システムコマンドから呼び出す方法と, `reticulate` パッケージを使うものがある. `reticulate` 登場以前はチャンクごとに呼び出していたため複数のチャンクに分割して記述するのが難しかったが, 現在は `reticulate` パッケージを利用することでRと同じような感覚で, あるいは Jupyter のコードセルと同じような感覚で書ける.

`pyenv` を使用する場合, 共有ライブラリのインストールが必要なことに注意[^pyenv-lib].

[^pyenv-lib]: 詳しくはこちらを参考に https://ill-identified.hatenablog.com/entry/2019/11/15/010746

初めて使う場合は先に `reticulate` 単体でPythonが実行できるか検証してからの方が良い.

```{r echo=T, eval=F}
require(reticulate)
# Python エンジンを認識しているか確認
py_discover_config()
repl_python()

# 以下, Python コマンド実行, `exit` で抜ける
```

現在 (`knitr` 1.18以降) は R Markdown はデフォルトで `reticulate` を使う. システムコマンド経由にしたい場合はチャンクオプション `python.reticulate=F` を設定する, あるいは `reticulate::eng_python` に変わるエンジンを自作する[^reticulate-knitr].

[^reticulate-knitr]: 参考: https://rstudio.github.io/reticulate/articles/r_markdown.html

あとはチャンクのエンジンに `r` ではなく `python` を指定することでPythonコードを埋め込める.

`matplotlib` エンジンで描いたグラフに日本語フォントを埋め込む場合, `matplotlib-japreset` を使えば必要な設定を一括で行う.

```{block type="rmdwarning"}
`matplotlib-japreset` は現在, Linux 以外での動作保証をしていない
```

```sh
pip install -U git+https://github.com/Gedevan-Aleksizde/matplotlib-japreset.git@master
```

```{python py-settings, echo=T}
from matplotlib_japreset import mplj_cairo
from matplotlib import rcParams
from plotnine import *
from plotnine.data import mtcars
rcParams['font.family']
```

`matplotlib-japreset` によって主要OSで標準インストールされている日本語フォントが自動的に選ばれる. 気に入らない場合は `rcParams['font.family']` に好きなフォント名を上書きする.

(ref:py-plotnine-cap) Python の `plotnine` によるグラフ表示例

```{python py-plotnine-cap, echo=T, results='hide', warning=F, fig.width=7, message=F, fig.cap="(ref:py-plotnine-cap)"}
ggplot(mtcars, aes('wt', 'mpg', color='factor(gear)')
) + geom_point() + stat_smooth(method='lm') + facet_wrap('~gear')
```

現状ではmatplotlibの標準出力や警告も表示されてしまうため, チャンクオプション `results='hide', warning=F, message=F` で隠すと良い.

## Python のグラフィックに関する制約

`matplotlib` ベースのグラフィックを出力したい場合, いくつかの制約がある.

* `matplotlib` > 3.2 では R がクラッシュするため, 3.2 を使用する必要
* `axes` を使用した場合 (`subplot` などが依存), `matplotlib.pyplot.show` の呼び出しと, 次に別のグラフを呼び出す前の `matplotlib.pyplot.close()` が必要
* `seaborn.FacetGrid` を Cairo デバイスで保存できない ( = フォントのサブセット化処理が複雑になる)

よって, 現状では `matplotlib` エンジンでグラフィックを描くときはなるべく `plotnine` を使ったほうがトラブルが少ない.

また `plotly`, `bokeh` などの `matplotlib` に依存しないモジュールはPDFには対応していないため直接表示できない. 一旦画像を保存して, あらためて画像ファイルを埋め込む必要がある.
