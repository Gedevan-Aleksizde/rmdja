# (PART) 応用編 {-}

# このパートについて {-}

このパートでは, ここまでで紹介した基本機能の応用で,  さまざまな R パッケージやその他の外部プログラムの出力を埋め込む方法を紹介する

# 様々なグラフィックプログラムの埋め込み {#advanced-graph}

## `tikz` を使う

`r rmdja::texlogo("latex")` で使われる `tikzdevice` を利用して, 直接  `tikz` の記述による画像を埋め込むことができる. チャンクのエンジンを `tikz` とすることで使用でき, 相互参照やキャプション, 画像サイズの指定といったチャンクオプションも使える. 図 \@ref(fig:tikz-venn) は `tikz` で生成した図である. これはHTMLでも表示できる. TODO: しかし現状ではpdflatex以外のエンジンに変更できないため, 日本語表示が難しい.

```{tikz tikz-venn, fig.cap="tikzを利用した図の表示"}
\def\firstcenter{(135:1.75cm)}
\def\secondcenter{(45:1.75cm)}
\def\firstcircle{\firstcenter circle (2.0cm)}
\def\secondcircle{\secondcenter circle (2.0cm)}
\def\wholerect{(-4.0, -1.1) rectangle(4.0, 3.35)}
\begin{tabular}{cc}
  % A cap B
  \begin{tikzpicture}
    \begin{scope}
       \clip \secondcircle;
       \fill[cyan] \firstcircle;
    \end{scope}
    \draw \wholerect;
    \draw \firstcircle;
    \draw \secondcircle;
    \begin{scope}[font=\small]
      \draw(90:.5cm) node[text=black, below]{\texttt{A INNER JOIN B}};
    \end{scope}
  \end{tikzpicture}
&
  % A u B
  \begin{tikzpicture}
    \begin{scope}
       \draw \wholerect;
       \fill[cyan]\firstcircle;
       \fill[cyan]\secondcircle;
     \end{scope}
     \begin{scope}[font=\small]
       \draw(90:.5cm) node[text=white, below]{\texttt{A OUTER JOIN B}};
     \end{scope}
  \end{tikzpicture}
\\
  % A LEFT B
  \begin{tikzpicture}
    \draw \wholerect;
    \draw \firstcircle;
    \draw \secondcircle;
    \begin{scope}
      \fill[cyan]\firstcircle;
      \draw\firstcenter;
      \draw\secondcenter;
   \end{scope}
   \begin{scope}[font=\small]
      \draw\firstcenter node[text=black, below]{\texttt{A LEFT JOIN B}};
   \end{scope}
  \end{tikzpicture}
&
  % A RIGHT B
  \begin{tikzpicture}
    \draw \wholerect;
    \draw \firstcircle;
    \draw \secondcircle;
    \begin{scope}
      \fill[cyan]\secondcircle;
      \draw\firstcenter;
      \draw\secondcenter;
   \end{scope}
   \begin{scope}[font=\small]
      \draw\secondcenter node[text=black, below]{\texttt{A RIGHT JOIN B}};
   \end{scope}
  \end{tikzpicture}
\\
\end{tabular}
```

## Asymptote を使う

同様に, Asymptote のプログラムを埋め込むこともできる. 私は Asymptote が分からないので RCB [Ch. 15.9 Create graphics with Asymptote](https://bookdown.org/yihui/rmarkdown-cookbook/eng-asy.html) と同様のプログラムを書いておく. (図 \@ref(fig:asymptote-graph)).

```{asy asymptote-graph, out.height="50%", fig.cap="Asymptote による画像"}
import graph3;
import grid3;
import palette;
settings.prc = false;
currentprojection=orthographic(0.8,1,2);
size(500,400,IgnoreAspect);
real f(pair z) {return cos(2*pi*z.x)*sin(2*pi*z.y);}
surface s=surface(f,(-1/2,-1/2),(1/2,1/2),50,Spline);
surface S=planeproject(unitsquare3)*s;
S.colors(palette(s.map(zpart),Rainbow()));
draw(S,nolight);
draw(s,lightgray+opacity(0.7));
grid3(XYZgrid);
```

## (TODO) その他のプログラム

D3.js なども使える

## (TODO) その他の R プログラム

なお, DOT言語は `DiagrammeR` パッケージを経由して使うこともできる[^rcb-diagrammer](図: \@ref(fig:diagrammer-graph)). グラフィカルモデルの記述などはこちらのほうが簡単かもしれない.

(ref:diagrammer-cap) `DiagrammeR` によるグラフィカルモデル (RCB, Ch. 4.15 より)

```{r diagrammer-graph, echo=T, fig.cap="(ref:diagrammer-cap)"}
DiagrammeR::grViz("digraph {
  graph [layout = dot, rankdir = TB]
  
  node [shape = rectangle]        
  rec1 [label = 'Step 1. 起床する']
  rec2 [label = 'Step 2. コードを書く']
  rec3 [label =  'Step 3. ???']
  rec4 [label = 'Step 4. 給料をもらう']
  
  # edge definitions with the node IDs
  rec1 -> rec2 -> rec3 -> rec4
  }", 
  height = 500)
```

[^rcb-diagrammer]: https://bookdown.org/yihui/rmarkdown-cookbook/diagrams.html


# 表の掲載

## TeX/HTML を出力する関数

`stargazer` や `xtable` のように, HTML や `\LaTeX`{=latex}`LaTeX`{=html} 形式で表を出力してくれるパッケージがある. これらは `results='asis'` のチャンクオプションを指定することで関数の出力するテキストをそのまま埋め込むことができる. よって, あとは HTMLか`\LaTeX`{=latex}`LaTeX`{=html} かといった出力形式の違いに気をつければ表示できる.

(ref:stargazer-title) `stargazer` による表の出力

```{r stargazer-table, echo=T, results='asis', fig.cap="(ref:stargazer-title)"}
require(stargazer)
stargazer(mtcars, type = if(knitr::is_latex_output()) 'latex' else 'html', header = F)
```

# 文献引用 

## `(u)p\BibTeX`{=latex}`(u)pBibTeX`{=html} を使う

日本語対応 `.bst` ファイルを使いたい場合は少しトリッキーな操作が必要になる. `rmarkdown` は `tinytex` というパッケージでインストールされたスタンドアローンな処理系で PDF を生成している. 冒頭のチャンクで `options(tinytex.latexmk.emulation = F)` を指定することで, 自分のマシンにインストールされている普段使っている処理系に処理させることができる. さらに `rmdja` では `natbib` を指定した場合に自動でカレントディレクトリに `.latexmkrc` をコピーするようにしている. しかしログが残らないなどデバッグしづらいところがあるため, このやり方はやや使いづらい.

TODO: この操作なしに (u)`\pBibTeX`{=latex}`pBibTeX`{=html} を使うには, たぶん `tinytex` と `rmarkdown` 両方の修正が必要. そこまで複雑ではないと思うのでそのうち修正してみたい.


## (TODO) BibLaTeX

TODO

## (TODO) pandoc-citeproc

##  (TODO) `gt` パッケージ

TODO

# (TODO) Web アプレットの挿入 {#webapp}

### TODO: plotly

### TODO: shiny

# Python スクリプトの埋め込み {#python}

Python スクリプトを埋め込むこともできる. 方法は2通りあり, 都度システムコマンドから呼び出す方法と, `reticulate` パッケージを使うものがある. `reticulate` 登場以前はチャンクごとに呼び出していたため複数のチャンクに分割して記述するのが難しかったが, 現在は `reticulate` パッケージを利用することでRと同じような感覚で, あるいは Jupyter のコードセルと同じような感覚で書ける.

`pyenv` を使用する場合, 共有ライブラリのインストールが必要なことに注意[^pyenv-lib].

[^pyenv-lib]: 詳しくはこちらを参考に https://ill-identified.hatenablog.com/entry/2019/11/15/010746

初めて使う場合は先に `reticulate` 単体でPythonが実行できるか検証してからの方が良い.

```{r echo=T, eval=F}
require(reticulate)
# Python エンジンを認識しているか確認
py_discover_config()
repl_python()

# 以下, Python コマンド実行, `exit` で抜ける
```

現在 (`knitr` 1.18以降) は R Markdown はデフォルトで `reticulate` を使う. システムコマンド経由にしたい場合はチャンクオプション `python.reticulate=F` を設定する, あるいは `reticulate::eng_python` に変わるエンジンを自作する[^reticulate-knitr].

[^reticulate-knitr]: 参考: https://rstudio.github.io/reticulate/articles/r_markdown.html

あとはチャンクのエンジンに `r` ではなく `python` を指定することでPythonコードを埋め込める.

`matplotlib` エンジンで描いたグラフに日本語フォントを埋め込む場合, `matplotlib-japreset` を使えば必要な設定を一括で行う.

```{block type="rmdwarning"}
`matplotlib-japreset` は現在, Linux 以外での動作保証をしていない
```

```sh
pip install -U git+https://github.com/Gedevan-Aleksizde/matplotlib-japreset.git@master
```

```{python py-settings, echo=T}
from matplotlib_japreset import mplj_cairo
from matplotlib import rcParams
from plotnine import *
from plotnine.data import mtcars
rcParams['font.family']
```

`matplotlib-japreset` によって主要OSで標準インストールされている日本語フォントが自動的に選ばれる. 気に入らない場合は `rcParams['font.family']` に好きなフォント名を上書きする.

(ref:py-plotnine-cap) Python の `plotnine` によるグラフ表示例

```{python py-plotnine-cap, echo=T, results='hide', warning=F, fig.width=7, message=F, fig.cap="(ref:py-plotnine-cap)"}
ggplot(mtcars, aes('wt', 'mpg', color='factor(gear)')
) + geom_point() + stat_smooth(method='lm') + facet_wrap('~gear')
```

現状ではmatplotlibの標準出力や警告も表示されてしまうため, チャンクオプション `results='hide', warning=F, message=F` で隠すと良い.

`plotly`, `bokeh` などの `matplotlib` に依存しないモジュールはPDFには対応していないため直接表示できない. 一旦画像を保存して, あらためて画像ファイルを埋め込む必要がある.
